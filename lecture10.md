# Raisetech 第十回講義

## インフラ自動化

インフラの自動化の前提として Infrastructure as Code[IaC]がある。
Infrastructure as Code とは何かというとインフラ環境をコード化して表現する考え方のこと。
自動化しようとする前まではインフラエンジニアがサーバーにアプリケーションをインストールしたり、設定を行うことでインフラを構築していたがこれらの作業は手順書などはあるが「再現性」が低く、問題が起きた時の対処がその都度違うことがあり問題視され続けていた。その問題点を解決する為に登場したのが「仮想化」、環境をそのまま保持し再現するための技術で今では当たり前となっている。仮想化によって１つのサーバー、１つのマシンに複数の環境を構築することが容易になった。
この仮想化を利用して作られたサービスが現在クラウドサービスと呼ばれている Azure,Google Cloud,もちろん今学習している AWS もこのサービスに属している。これらのサービスは特定のサーバー環境に複数の仮想環境を作り、それを提供することで運営されている。クラウド化が進み仮想環境が当たり前になってくると環境を生成する手段が API として外部提供されるようになり、コマンドラインやプログラムで実行できるようになることからインフラ環境のコード化がいよいよ現実的なお話になっていく。
余談だがクラウド以外での仮想化を利用したレンタルサーバーのようなサービスも存在しているが違いとしては仮想化の範囲が CPU やメモリレベルである点を挙げることができる。また、サーバーを借りるのではなくサービスを利用する点も異なる。
話を戻して API として外部提供されるようになるとインフラ環境をコードで表現できるようになるのでアプリケーションエンジニアがインフラ環境構築にも手を出し始める、なぜなら彼らこそインフラ環境を欲しがっておりそれがプログラムで実現できるとなって自分達の領域のお話になったから。そして Infrastructure as Code という考え方が生まれ、それに沿ってインフラ環境をコード化する為のツールやサービスが生まれ、現在のインフラ自動化技術へと繋がっている。どうしてここまで自動化にこだわるかというと「再現性」を担保したいからだと言える。何度やっても同じ環境を作り直すことができるのは非常に再現性が高いと言える。

## 自動化のメリット

再現性を持たせた環境構築のメリットとして、問題解決の利点、再現の速さ、環境が仮想化されていることによるサーバー管理が不要というようなコスト削減を実現できる。
コードで管理されるのでバージョン管理システムを使っての管理なので以前の状態に戻すこともできる点や環境の変化を差分として確認できるのでここでも開発のコスト削減が実現できる。
IaC が出るまではインフラ差分管理は構成図にバージョン版図を付けて対応。バージョンをどうつけるのかは人の裁量に任せていたため非常に管理が困難。

## 自動化のデメリット

開発コストの削減ができるので全て自動化すればと思う我がちだがデメリットも存在する。自動化をする為の技術者が必要である事。それをメンテナンスする人材も必要。自動化できる技術者は少なくその人が現場からいなくなった時に誰がメンテナンスするのかという問題もある。そもそもできる人が少ないので今までの仕組みで行こうとする職場が多い。

## 全自動と半自動

自動化にも二種類あり、全く人の手を介さずに行う自動化である「全自動」と人の手がいくつか介在する「半自動」に分けられる。
全自動の例として定時起動などの運用時に発生する何らかのトリガーを元に処理が走るのが全自動。
半自動の例として、実行自体は自動で行われるが途中経過、実行の継続には人の手がいるような状態。重要な処理や人の目で見ないと確認できないような場合に使われる。二つとも用途で使い分けるものなので、常に全自動を目指すことはない。しかし、全自動可能なものを「心配だから」という理由で半自動にするのは自動化を進める上で起こりやすい障害。誰が責任をとるんだというような政治的な問題がある。

## 自動化の範囲

インフラ環境に限らず自動化をする場合は、どこまで自動化するのかを常に考え続ける必要がある。なぜなら何でも間でも自動化してしまうとかえって効率が悪くなる場合もから。手順としてはまずは全自動を目指す。人の手が要らないところを徹底的に自動化していく。その過程で自動化出来ない部分や自動化させてもらえない壁が現れる。その時に自動化を続けるために仕組みを変える道か、人の手でやり続けるかを選択する必要がある。人の手でやり続けることを選択した場合は少しづつ自動化して行く方向で進めていく、そうやって自動化の範囲を徐々に定めて行くのが無難。

## CloudFormation

インフラ自動化を AWS で行う場合に利用されるのが[CloudFormation]。このサービスは YAML 形式で書かれた Template ファイルを読み込むことで Stack という一つの単位で環境を構築してくれるサービス。スライドでは VPC を作成しているので参照。（今回の課題にも使う為）
テンプレートの作成はそれなりに難しい。YAML はインデントで階層を表現する点や実行エラーも一癖あるのでエラー解決にはそれなりに時間がかかる。テンプレートが完成したら CloudFormation デザイナーのチェック機能でエラーがにあか確認は最低限やっておく。
Stack は Template を Cloud Formation に通した数だけできる自動生成された環境そのもの、Stack 管理下にある EC2 や RDS に変更が加えられた場合 Stack 側で検出ができる。また Template ファイルを修正して同じ Stack に読み込みし直せば更新も行える。Stack を削除すると、対象の環境が全て削除される。
Stack を作ろうとして何らかの理由で失敗した場合、デフォルトで CloudFormation は Stack で作ろうとしていた環境を無かったことにする。途中まで作っていたものを削除して作る前の状態に戻すということ。ただしエラーになった Stack 自体の削除は行わない点に注意、理由としてはエラーの原因の確認のためなど勝手には消さない。そのため同じ Stack 名で作成しようとしてエラーが出る場合は先ほどの可能性を考えてみる。原因が分かり次第手動で削除するのが一般的。

## CloudFormation 理解に必要なキーワード

テンプレート(Template)
CloudFormation のコードが書かれたファイルの呼び名。形式としては YAML、JSON。
スタック(Stack)
１つのテンプレートから生成された各種リソースをまとめた管理単位。１テンプレート＝１スタックの関係。
リソース ID
AWS の全てのリソースは一意（重複しない）ID が存在していて、AWS はこれらの ID を用いてリソースの存在の有無や主従関係や紐付けまでを管理。

## 主要な要素一覧

### AWSTemplateFormation Version

テンプレート形式のバージョンだが既に長い間変更がなく固定値と考えて OK。「AWSTemplateFormatVersion: 2010-09-09」

### Description

テンプレートの説明。この説明はスタックの説明としてコンソールに表示。

### Parameters

カスタマイズ可能な論理 ID の設定。スライドでは文字列を NameBase に格納している。論理 ID の説明と呼び出し方は後で説明。

### Resources

作りたいものをリソースと呼んで、ここに各種リソースを定義していく。

### Outputs

スタック内のリソース ID を他のスタックから呼び出し可能にさせる為の機能。ここで定義した ID は ImportValue を用いて呼び出しが可能。例としては、VPC の ID を定義しておいて、セキュリティグループから参照するなど。（これをクロススタック参照と呼ぶ。）

### 論理 ID

Resources の次の行の記述は論理 ID(Logical ID)と呼ばれる。スライドでは NameBase と Vpc1 が論理 ID。
論理 ID と呼ぶのは VPC など AWS リソースが作成された瞬間にリソース ID が付与されるのでそれと区別するための名称。論理 ID をリソース ID の関連付けに使うことで「リソース ID が確定していないと関連付けの記述ができない」ということがなくなる。

### 組み込み関数を使った論理 ID の呼び出し

スライドでは NameBase を文字列として結合して使うために Sub 関数での呼び出しをおこなっている。これにより VPC の名前部分で NameBase が参照され、vpc-RaiseTekkun という文字になる。テンプレート内で使える関数は組み込み関数と呼ばれる。詳細は AWS ドキュメント参照。

### ユーザーデータ

EC2 にはインスタンス起動時に一度だけ実施して欲しいコマンドをユーザーデータで定義できる。スライドでは Apache(HTTP サーバー)をインストールして起動するコマンドが書かれている。OS 上でスクリプトを設定しても良いがマシンが生成される一度だけ実行というのがポイント。
